#!/bin/bash

# Delete previous sources
echo "Deleting previous sources..."
rm -rf device/xiaomi/tanzanite
rm -rf device/xiaomi/tanzanite-kernel
rm -rf vendor/xiaomi/tanzanite
rm -rf packages/apps/ViPER4AndroidFX
rm -rf hardware/xiaomi
rm -rf hardware/mediatek
rm -rf device/mediatek/sepolicy_vndr
rm -rf vendor/mediatek/ims
# rm -rf vendor/*priv*
rm -rf vendor/lineage-priv/keys
rm -rf .repo/local_manifests

repo init -u https://github.com/crdroidandroid/android.git -b 16.0 --git-lfs --no-clone-bundle
git clone https://github.com/iamCloverDT/tanzanite_local_manifests.git --depth=1 -b lineage-23.2 .repo/local_manifests
/opt/crave/resync.sh

echo "Creating signing keys.."
wget https://raw.githubusercontent.com/crdroidandroid/crDroid-build-signed-script/refs/heads/16.0/create-signed-env.sh
wget https://raw.githubusercontent.com/crdroidandroid/crDroid-build-signed-script/refs/heads/16.0/keys.mk
chmod +x create-signed-env.sh
./create-signed-env.sh
echo "Finished creating signing keys."

echo "Patching wpa_supplicant_8..."
pushd external/wpa_supplicant_8
wget https://raw.githubusercontent.com/nathanzerogarage/patches/refs/heads/main/do_not_set_NL80211_WPA_VERSION_3.patch
patch -p1 < do_not_set_NL80211_WPA_VERSION_3.patch
popd
echo "wpa_supplicant_8 was patched."

echo "Patching Apeture..."
pushd packages/apps/Aperture
wget https://raw.githubusercontent.com/nathanzerogarage/patches/refs/heads/main/01-aperture-mtk-hfps-mode.patch
patch -p1 < 01-aperture-mtk-hfps-mode.patch
popd
echo "Aperture was patched."

rm -rf out

. build/envsetup.sh

export BUILD_HOSTNAME=crave
export BUILD_USERNAME=clover
export TZ=America/Recife
# Building the ROM
echo "--------------------------"
echo "Starting ROM compilation.."
echo "--------------------------"
brunch tanzanite
